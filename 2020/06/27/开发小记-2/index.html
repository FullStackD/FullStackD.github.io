<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 3.9.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"yoursite.com",root:"/",scheme:"Pisces",version:"8.0.0-rc.3",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12},copycode:!1,bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!0,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!1,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="关于Jedis的坑今天分享一个白衣大大在微博中说明的关于Jedis的坑  “基础架构部之jedis中坑人的maxIdle参数”，jedis用的是apache commons pools做连接池。 连接池大小由minIdle，maxIdle，maxTotal三个参数控制。头一个和末一个好理解，就是连接池的最小和最大值，而maxIdle就比较坑人了，连接用完后，如果连接池小于maxIdle，就放回连接"><meta property="og:type" content="article"><meta property="og:title" content="开发小记（二）"><meta property="og:url" content="http://yoursite.com/2020/06/27/开发小记-2/index.html"><meta property="og:site_name" content="不忘初心"><meta property="og:description" content="关于Jedis的坑今天分享一个白衣大大在微博中说明的关于Jedis的坑  “基础架构部之jedis中坑人的maxIdle参数”，jedis用的是apache commons pools做连接池。 连接池大小由minIdle，maxIdle，maxTotal三个参数控制。头一个和末一个好理解，就是连接池的最小和最大值，而maxIdle就比较坑人了，连接用完后，如果连接池小于maxIdle，就放回连接"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2020-06-28T14:39:56.743Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="开发小记（二）"><meta name="twitter:description" content="关于Jedis的坑今天分享一个白衣大大在微博中说明的关于Jedis的坑  “基础架构部之jedis中坑人的maxIdle参数”，jedis用的是apache commons pools做连接池。 连接池大小由minIdle，maxIdle，maxTotal三个参数控制。头一个和末一个好理解，就是连接池的最小和最大值，而maxIdle就比较坑人了，连接用完后，如果连接池小于maxIdle，就放回连接"><link rel="canonical" href="http://yoursite.com/2020/06/27/开发小记-2/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>开发小记（二） | 不忘初心</title><noscript><style>body{margin-top:2rem}.sidebar-inner,.use-motion .collection-header,.use-motion .comments,.use-motion .header-inner,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header,.use-motion .site-brand-container .toggle{opacity:initial}.use-motion .custom-logo-image,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line{transform:scaleX(1)}.search-pop-overlay,.sidebar-nav{display:none}.sidebar-panel{display:block}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">不忘初心</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">少年,专心练剑吧</p></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> 归档</a></li><li class="menu-item menu-item-books"><a href="/books/" rel="section"><i class="fa fa-book fa-fw"></i> 书单</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i> 关于</a></li></ul></nav></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><section class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#关于Jedis的坑"><span class="nav-number">1.</span> <span class="nav-text">关于Jedis的坑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-6之I-O多线程"><span class="nav-number">2.</span> <span class="nav-text">Redis 6之I/O多线程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-6-0-之前为什么一直不使用多线程？"><span class="nav-number">2.1.</span> <span class="nav-text">Redis 6.0 之前为什么一直不使用多线程？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-6-0-为什么要引入多线程呢？"><span class="nav-number">2.2.</span> <span class="nav-text">Redis 6.0 为什么要引入多线程呢？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-6-0-默认是否开启了多线程？"><span class="nav-number">2.3.</span> <span class="nav-text">Redis 6.0 默认是否开启了多线程？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-6-0-多线程的实现机制？"><span class="nav-number">2.4.</span> <span class="nav-text">Redis 6.0 多线程的实现机制？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">3.</span> <span class="nav-text">参考</span></a></li></ol></div></section><section class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Monster" src="/images/avatar.png"><p class="site-author-name" itemprop="name">Monster</p><div class="site-description" itemprop="description">Stay young, Stay hungry, Stay foolish.</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">35</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">46</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/yourname" title="GitHub → https://github.com/yourname" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:yourname@gmail.com" title="E-Mail → mailto:yourname@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://plus.google.com/yourname" title="Google → https://plus.google.com/yourname" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i> Google</a></span></div></section><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></header> <a href="https://github.com/fullstackd" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div id="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/27/开发小记-2/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="Monster"><meta itemprop="description" content="Stay young, Stay hungry, Stay foolish."></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="不忘初心"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 开发小记（二）</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-06-27 11:15:05" itemprop="dateCreated datePublished" datetime="2020-06-27T11:15:05+08:00">2020-06-27</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-06-28 22:39:56" itemprop="dateModified" datetime="2020-06-28T22:39:56+08:00">2020-06-28</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发小记/" itemprop="url" rel="index"><span itemprop="name">开发小记</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="关于Jedis的坑"><a href="#关于Jedis的坑" class="headerlink" title="关于Jedis的坑"></a>关于Jedis的坑</h2><p>今天分享一个白衣大大在微博中说明的关于Jedis的坑</p><blockquote><p>“基础架构部之jedis中坑人的maxIdle参数”，jedis用的是apache commons pools做连接池。</p><p>连接池大小由minIdle，maxIdle，maxTotal三个参数控制。头一个和末一个好理解，就是连接池的最小和最大值，而maxIdle就比较坑人了，连接用完后，如果连接池小于maxIdle，就放回连接池，大于就直接扔掉。</p><p>又有这么一个应用，把三个值分别设为2，10，40，当压力来了，10个连接不够用了，就要频繁创连接，执行完一个命令就丢掉，下一个命令再创，再丢，cps(new connection per second) 的值，等于没有在原来10条连接里处理的qps，我们称为连接风暴。</p><p>这时候redis可遭罪了，单线程又要处理命令，又要处理连接创建，两头忙两头不是人（redis 6独立的io线程可以改善么？）</p><p>所以，maxIdle应该就和maxTotal同一个值，别开放出去让人配了。</p><p>另外一开始池里也没有minIdle所指定的最少连接数，可以应用启动时做一下预热。</p></blockquote><p>当时看到这个以后，由于我们的项目中也在用Jedis于是去检查了一下参数是如何设置的，maxIdle确实和maxTotal同一个值，但是配置并不规范，连接池的参数都写在了代码中，而非配置文件。</p><a id="more"></a><hr><h2 id="Redis-6之I-O多线程"><a href="#Redis-6之I-O多线程" class="headerlink" title="Redis 6之I/O多线程"></a>Redis 6之I/O多线程</h2><p>这里看到白衣大大提到，Redis 6的I/O多线程，也顺便了解一下。</p><h3 id="Redis-6-0-之前为什么一直不使用多线程？"><a href="#Redis-6-0-之前为什么一直不使用多线程？" class="headerlink" title="Redis 6.0 之前为什么一直不使用多线程？"></a>Redis 6.0 之前为什么一直不使用多线程？</h3><blockquote><p>使用了单线程后，可维护性高。多线程模型虽然在某些方面表现优异，但是它却引入了程序执行顺序的不确定性，带来了并发读写的一系列问题，增加了系统复杂度、同时可能存在线程切换、甚至加锁解锁、死锁造成的性能损耗。</p><p>Redis 通过 AE 事件模型以及 IO 多路复用等技术，处理性能非常高，因此没有必要使用多线程。</p><p>单线程机制使得 Redis 内部实现的复杂度大大降低，Hash 的惰性 Rehash、Lpush 等等 “线程不安全” 的命令都可以无锁进行。</p></blockquote><h3 id="Redis-6-0-为什么要引入多线程呢？"><a href="#Redis-6-0-为什么要引入多线程呢？" class="headerlink" title="Redis 6.0 为什么要引入多线程呢？"></a>Redis 6.0 为什么要引入多线程呢？</h3><blockquote><p>之前的段落说了，Redis 的瓶颈并不在 CPU，而在内存和网络。</p><p>内存不够的话，可以加内存或者做数据结构优化和其他优化等，但网络的性能优化才是大头，网络 IO 的读写在 Redis 整个执行期间占用了大部分的 CPU 时间，如果把网络处理这部分做成多线程处理方式，那对整个 Redis 的性能会有很大的提升。</p><p>优化方向：</p><ul><li>提高网络 IO 性能，典型的实现比如使用 DPDK 来替代内核网络栈的方式。</li><li>使用多线程充分利用多核，典型的实现比如 Memcached。</li></ul><p>所以总结起来，Redis 支持多线程主要就是两个原因：</p><ul><li>可以充分利用服务器 CPU 资源，目前主线程只能利用一个核。</li><li>多线程任务可以分摊 Redis 同步 IO 读写负荷。</li></ul></blockquote><h3 id="Redis-6-0-默认是否开启了多线程？"><a href="#Redis-6-0-默认是否开启了多线程？" class="headerlink" title="Redis 6.0 默认是否开启了多线程？"></a>Redis 6.0 默认是否开启了多线程？</h3><blockquote><p>否，在conf文件进行配置</p><p>io-threads-do-reads yes</p><p>io-threads 线程数</p></blockquote><h3 id="Redis-6-0-多线程的实现机制？"><a href="#Redis-6-0-多线程的实现机制？" class="headerlink" title="Redis 6.0 多线程的实现机制？"></a>Redis 6.0 多线程的实现机制？</h3><p><img data-src="https://i.loli.net/2020/06/27/dPoVp75l61FWDrz.png" alt="1712130-20200516174816219-1469215261.png"></p><p><strong>流程简述如下</strong>：</p><ul><li>主线程负责接收建立连接请求，获取 Socket 放入全局等待读处理队列。</li><li>主线程处理完读事件之后，通过 RR（Round Robin）将这些连接分配给这些 IO 线程。</li><li>主线程阻塞等待 IO 线程读取 Socket 完毕。</li><li>主线程通过单线程的方式执行请求命令，请求数据读取并解析完成，但并不执行。</li><li>主线程阻塞等待 IO 线程将数据回写 Socket 完毕。</li><li>解除绑定，清空等待队列。</li></ul><p><img data-src="https://i.loli.net/2020/06/27/134htJwXAypduBm.png" alt="1712130-20200516174905348-1186276910.png"></p><p>该设计有如下特点：</p><ul><li>IO 线程要么同时在读 Socket，要么同时在写，不会同时读或写。</li><li>IO 线程只负责读写 Socket 解析命令，不负责命令处理。</li></ul><p>这样看来的话，还是不能解决Jedis配置在maxIdle&lt;maxTotal时，导致的频繁创建和执行命令的问题。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li>[1] <a href="https://weibo.com/1728555142/J7c6B1q35" target="_blank" rel="noopener">https://weibo.com/1728555142/J7c6B1q35</a></li><li>[2] <a href="https://www.cnblogs.com/gz666666/p/12901507.html" target="_blank" rel="noopener">Redis 6.0 多线程重磅发布！！！</a></li></ul></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-item"><a href="/2020/06/26/开发小记-1/" rel="prev" title="开发小记（一）"><i class="fa fa-chevron-left"></i> 开发小记（一）</a></div><div class="post-nav-item"> <a href="/2020/06/27/吾日三省吾身/" rel="next" title="吾日三省吾身">吾日三省吾身<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Monster</span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script></body></html>